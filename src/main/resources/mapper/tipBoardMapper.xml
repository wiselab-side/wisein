<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wisein.wiselab.mapper.tipBoardMapper">
    <!--
        카테고리 선택 :  선택한 카테고리의 글만 보여야하기 때문에
                         WHERE 절에 AND 조건을 추가하는 방식으로 구현했다.
                         또한 카테고리 별 게시글 개수가 다르기 때문에 게시글 Count에도 추가해줬다.

            제목 정렬 :  ORDER BY를 통해 각각 오름차순과 내림차순으로 정렬했고
                         선택하지 않은 경우에는 최신글 순서(NUM DESC)로 정렬되도록 구현했다.
                         오름차순의 우선순위는 특수문자-숫자-영어-한글 순이다
    -->
    <!-- 카테고리 정렬 -->
    <sql id="tipListCategory">
        <if test="category == 'FRONT'">
            AND CATEGORY = 'FRONT'
        </if>
        <if test="category == 'BACK'">
            AND CATEGORY = 'BACK'
        </if>
        <if test="category == 'DB'">
            AND CATEGORY = 'DB'
        </if>
    </sql>
    <!-- 제목 정렬 -->
    <sql id="tipListSubject">

        <if test="subject =='DESC'">
            SUBJECT DESC,
        </if>
    </sql>

    <!-- 좋아요 OR 스크랩 정렬-->
    <sql id="sortOrder">
        <if test="sortValue != null and orderValue != null">
            ${orderValue} ${sortValue},
        </if>
    </sql>

    <!--
        TIP 게시판 스크랩 모아보기
        댓글 수를 표현하기 위해 COMMENT 테이블과 LEFT OUTER JOIN
        스크랩 수를 표현하기 위해 SCRAP_BOARD 테이블과 INNER JOIN
        USER_ID 는 현재 로그인 한 회원의 아이디
     -->

    <!-- TIP 스크랩 모아보기 -->
    <select id="selectScrapTipList" parameterType="TipBoardDTO" resultType="TipBoardDTO">
        SELECT ROW_NUMBER() OVER (ORDER BY TB.NUM DESC) AS RNUM
             , TB.NUM
             , TB.CATEGORY
             , TB.WRITER
             , TB.SUBJECT
             , TB.CONTENT
             , TB.REG_DATE
             , TB.UPD_DATE
             , TB.DEL_YN
             , TB.PARENT_NUM
             , TB.LIKE_COUNT
             , TB.SCRAP_COUNT
             , COUNT(COM.BOARD_IDX)                     AS COMM_CNT
          FROM TIP_BOARD TB
        LEFT JOIN COMMENT COM
               ON TB.NUM = COM.BOARD_IDX
              AND COM.DEL_YN = 'n'
              AND COM.BOARD_TYPE = 'tip'
        INNER JOIN SCRAP_BOARD SB
                ON TB.NUM = SB.BOARD_IDX
        WHERE SB.USER_ID = #{writer}
          AND SB.BOARD_TYPE = 'tip'
          AND TB.DEL_YN = 'N'
          <![CDATA[AND TB.NUM > 0]]>
          AND CATEGORY = CASE WHEN #{searchType} != 'all' THEN #{searchType}
                              ELSE CATEGORY
                          END
          AND SUBJECT LIKE CONCAT ('%', #{keyword}, '%')
          <include refid="tipListCategory"/>
        GROUP BY TB.NUM
        ORDER BY
        <include refid="sortOrder"/>
        <![CDATA[
            CASE
                WHEN TRIM(REGEXP_REPLACE(SUBJECT, '<[^>]+>', '')) = '' THEN 1
                WHEN SUBJECT REGEXP '^[가-힣ㄱ-ㅎㅏ-ㅣ]' THEN 2
                WHEN SUBJECT REGEXP '^[A-Za-z]' THEN 3
                WHEN SUBJECT REGEXP '^[0-9]' THEN 4
                ELSE 5
            END,]]>
         <include refid="tipListSubject"/> TB.NUM DESC
        LIMIT #{firstRecordIndex}, #{RECORDSPERPAGE}
    </select>

    <select id="selectMemberTipScrapTotalCount" parameterType="TipBoardDTO" resultType="int">
        SELECT COUNT(NUM)
          FROM TIP_BOARD TB
        INNER JOIN SCRAP_BOARD SB
                ON TB.NUM = SB.BOARD_IDX
         WHERE SB.USER_ID = #{writer}
           AND SB.BOARD_TYPE = 'tip'
           <include refid="tipListCategory"/>
    </select>



    <!--TipBoard 다건조회-->
    <select id="selectTipList" parameterType="TipBoardDTO" resultType="TipBoardDTO">
            SELECT A.RNUM
                  ,A.NUM
                  ,A.CATEGORY
                  ,A.WRITER
                  ,A.SUBJECT
                  ,A.CONTENT
                  ,A.REG_DATE
                  ,A.UPD_DATE
                  ,A.DEL_YN
                  ,A.PARENT_NUM
                  ,A.LIKE_COUNT
                  ,A.SCRAP_COUNT
                  ,(SELECT COUNT(*)
                      FROM COMMENT COM
                     WHERE COM.BOARD_IDX = A.NUM
                       AND COM.DEL_YN = 'n'
                       AND COM.BOARD_TYPE ='tip') AS COMM_CNT
            FROM (SELECT @ROWNUM:=@ROWNUM+1 AS RNUM
                        ,TB.NUM
                        ,TB.CATEGORY
                        ,TB.WRITER
                        ,TB.SUBJECT
                        ,TB.CONTENT
                        ,TB.REG_DATE
                        ,TB.UPD_DATE
                        ,TB.DEL_YN
                        ,TB.COUNT
                        ,TB.PARENT_NUM
                        ,TB.LIKE_COUNT
                        ,TB.SCRAP_COUNT
                   FROM TIP_BOARD TB
                       ,(SELECT @ROWNUM:=0) R
                  WHERE 1=1
                    AND CATEGORY = CASE WHEN #{searchType} != 'all' THEN #{searchType} ELSE CATEGORY END
                    AND SUBJECT LIKE CONCAT ('%', #{keyword}, '%')
                    AND DEL_YN = 'N'
                    <![CDATA[
                    AND TB.NUM > 0
                    ]]>
                    <include refid="tipListCategory"/>
                  GROUP BY TB.NUM
                  ORDER BY <include refid="sortOrder"/>
                           <include refid="tipListSubject"/>
                           NUM DESC
                  ) AS A
           LIMIT #{firstRecordIndex}, #{RECORDSPERPAGE}
    </select>

    <!--TipBoard 작성글 모아보기-->
    <select id="selectMemberTipList" parameterType="TipBoardDTO" resultType="TipBoardDTO">
        <![CDATA[
            SELECT A.RNUM
                  ,A.NUM
                  ,A.CATEGORY
                  ,A.WRITER
                  ,A.SUBJECT
                  ,A.CONTENT
                  ,A.REG_DATE
                  ,A.UPD_DATE
                  ,A.DEL_YN
                  ,A.PARENT_NUM
                  ,A.LIKE_COUNT
                  ,A.SCRAP_COUNT
                  ,(SELECT COUNT(*)
                      FROM COMMENT COM
                     WHERE COM.BOARD_IDX = A.NUM
                       AND COM.DEL_YN = 'n'
                       AND COM.BOARD_TYPE ='tip') AS COMM_CNT
            FROM (SELECT @ROWNUM:=@ROWNUM+1 AS RNUM
                        ,TB.NUM
                        ,TB.CATEGORY
                        ,TB.WRITER
                        ,TB.SUBJECT
                        ,TB.CONTENT
                        ,TB.REG_DATE
                        ,TB.UPD_DATE
                        ,TB.DEL_YN
                        ,TB.COUNT
                        ,TB.PARENT_NUM
                        ,TB.LIKE_COUNT
                        ,TB.SCRAP_COUNT
                   FROM TIP_BOARD TB
                       ,(SELECT @ROWNUM:=0) R
                  WHERE 1=1
                    AND CATEGORY = CASE WHEN #{searchType} != 'all' THEN #{searchType} ELSE CATEGORY END
                    AND SUBJECT LIKE CONCAT ('%', #{keyword}, '%')
                    AND WRITER = #{writer}
                    AND DEL_YN = 'N'
                    AND TB.NUM > 0]]>
                  GROUP BY TB.NUM
                  ORDER BY NUM DESC
                  ) AS A
           LIMIT #{firstRecordIndex}, #{RECORDSPERPAGE}
        </select>


    <!--TipBoard 단건조회-->
    <select id="selectTipOne" parameterType="TipBoardDTO" resultType="TipBoardDTO">
        SELECT NUM
              ,CATEGORY
              ,WRITER
              ,SUBJECT
              ,CONTENT
              ,REG_DATE
              ,UPD_DATE
              ,DEL_YN
              ,COUNT
              ,PARENT_NUM
              ,LIKE_COUNT
         FROM TIP_BOARD
        WHERE NUM = #{num}
    </select>

    <!--TipBoard 게시글 등록-->
    <insert id="insertTipBoard" parameterType="TipBoardDTO">
        INSERT INTO TIP_BOARD
              (NUM
              ,CATEGORY
              ,WRITER
              ,SUBJECT
              ,CONTENT
              ,REG_DATE
              ,DEL_YN
              )
        VALUES
              ((SELECT NVL(MAX(num), 0) + 1 FROM tip_board ALIAS_FOR_SUBQUERY)
              ,#{category}
              ,#{writer}
              ,#{subject}
              ,#{content}
              ,(SELECT date_format(now(),'%Y-%c-%d'))
              ,'N'
              )
    </insert>

    <!--TipBoard 게시글 삭제-->
    <update id="deleteTipBoard" parameterType="Integer">
        UPDATE TIP_BOARD
           SET DEL_YN = 'Y'
         WHERE NUM = #{num}
    </update>

    <!--TipBoard 게시글 수정-->
    <update id="updateTipBoard" parameterType="TipBoardDTO">
        UPDATE TIP_BOARD
           SET CATEGORY = #{category}
              ,SUBJECT = #{subject}
              ,CONTENT = #{content}
              ,UPD_DATE = (SELECT date_format(now(),'%Y-%c-%d'))
        WHERE NUM = #{num}
    </update>

    <!--TipBoard 게시글 번호 조회-->
    <select id="selectTipPostNum" parameterType="TipBoardDTO" resultType="Integer">
        SELECT NUM
          FROM TIP_BOARD
         WHERE WRITER = #{writer}
           AND SUBJECT = #{subject}
           AND CONTENT = #{content}
           AND DEL_YN = 'N'
         ORDER BY NUM desc limit 1
    </select>

    <!--TipBoard 다음 게시글 번호 조회-->
    <select id="selectNextTipNum" resultType="Integer">
        SELECT NVL(MAX(num), 0)+1 AS NUM
          FROM TIP_BOARD
    </select>

    <!--전체 게시글 개수 조회-->
    <!--카테고리 pageCount 처리를 위해 include-->
    <select id="selectBoardTotalCount" parameterType="TipBoardDTO" resultType="int">
        <![CDATA[
		SELECT COUNT(NUM)
		  FROM TIP_BOARD
	     WHERE 1=1
		   AND CATEGORY = CASE WHEN #{searchType} != 'all' THEN #{searchType} ELSE CATEGORY END
           AND SUBJECT LIKE CONCAT ('%', #{keyword}, '%')
		   AND DEL_YN = 'N'
		   AND NUM > 0]]>
		   <include refid="tipListCategory"/>

    </select>

    <!--모아보기 게시글 개수 조회-->
    <!--카테고리 pageCount 처리를 위해 include-->
    <select id="selectMemberTipTotalCount" parameterType="TipBoardDTO" resultType="int">
        <![CDATA[
		SELECT COUNT(NUM)
		  FROM TIP_BOARD
	     WHERE 1=1
		   AND CATEGORY = CASE WHEN #{searchType} != 'all' THEN #{searchType} ELSE CATEGORY END
           AND SUBJECT LIKE CONCAT ('%', #{keyword}, '%')
           AND WRITER = #{writer}
		   AND DEL_YN = 'N'
		   AND NUM > 0]]>
		   <include refid="tipListCategory"/>

    </select>



    <!-- 서치 게시글 총 개수 -->
    <select id="listSearchCount" resultType="int">
        <![CDATA[
		SELECT COUNT(NUM)
		  FROM TIP_BOARD
		 WHERE 1=1
		   AND NUM > 0
		]]>
    </select>

    <!-- 작성자 meetLink -->
    <select id="selectMeetLink" parameterType="Integer" resultType="string">
        SELECT MEET_LINK
          FROM MEMBER
         WHERE ID = (SELECT WRITER
                       FROM TIP_BOARD
                      WHERE NUM = #{num}
                        AND DEL_YN = 'N'
                     )
    </select>


</mapper>